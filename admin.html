<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sbolla Admin - Genera Storico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { transition: all 0.2s; backdrop-filter: blur(10px); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="text-slate-800 p-6">

    <div class="max-w-4xl mx-auto">
        
        <!-- Header con link a index.html -->
        <div class="bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl p-8 mb-8 text-center border border-white/20 relative">
            <!-- Link a index.html -->
            <a href="index.html" 
               class="absolute top-6 right-6 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold py-2 px-4 rounded-xl transition-all flex items-center gap-2 border border-indigo-200">
                <span>üöÄ</span>
                <span>Vai a Sbolla Manager</span>
            </a>
            
            <div class="text-7xl mb-4">üìã</div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                Sbolla Admin
            </h1>
            <p class="text-slate-500 mt-2 text-lg">Genera il file storico sbolla.json per la v3.0</p>
        </div>

        <!-- Card Principale -->
        <div class="bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl p-8 mb-8 card border border-white/20">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                <span class="w-2 h-8 bg-gradient-to-b from-indigo-500 to-purple-500 rounded-full"></span>
                Carica file Excel MASTER
            </h2>
            
            <div class="border-3 border-dashed border-slate-200 rounded-2xl p-16 text-center hover:border-indigo-300 transition-all cursor-pointer bg-slate-50/50 hover:bg-indigo-50/30" 
                 onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFile(this)">
                <div class="text-7xl mb-4 text-indigo-400">üìÇ</div>
                <div class="text-xl font-medium text-slate-600">Clicca per selezionare un file Excel</div>
                <div class="text-sm text-slate-400 mt-2">Verranno letti TUTTI gli interventi (storici e nuovi)</div>
            </div>

            <!-- Statistiche -->
            <div id="stats-section" class="hidden mt-8">
                <div class="border-t border-slate-200 pt-6">
                    <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-emerald-500 rounded-full"></span>
                        Anteprima dati caricati
                    </h3>
                    
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-slate-50 to-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">üìä Interventi totali</div>
                            <div class="text-3xl font-bold text-slate-800" id="stats-totale">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-white p-5 rounded-xl border border-emerald-200 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">üí∞ Interventi storici</div>
                            <div class="text-3xl font-bold text-emerald-600" id="stats-storici">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-white p-5 rounded-xl border border-blue-200 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">üÜï Interventi da prezzare</div>
                            <div class="text-3xl font-bold text-blue-600" id="stats-nuovi">0</div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="generaJSON()" 
                                class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center gap-2 text-lg">
                            üíæ Genera sbolla.json
                        </button>
                        <button onclick="reset()" 
                                class="bg-white border-2 border-slate-300 hover:bg-slate-50 text-slate-600 font-bold py-4 px-6 rounded-xl transition-all hover:border-slate-400">
                            ‚Ü∫ Annulla
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info su sbolla.json -->
        <div class="bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl p-8 card border border-white/20">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                <span class="w-2 h-8 bg-gradient-to-b from-emerald-500 to-teal-500 rounded-full"></span>
                Stato database storico
            </h2>
            
            <div id="json-info" class="text-center py-8">
                <div class="text-5xl mb-4 text-slate-300">üìÑ</div>
                <div class="text-slate-400">Nessun file rilevato</div>
            </div>
        </div>

        <!-- Istruzioni -->
        <div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-6 text-sm text-blue-800">
            <h4 class="font-bold text-lg mb-3 flex items-center gap-2">üìå Come funziona</h4>
            <ul class="space-y-2 text-blue-700">
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">1Ô∏è‚É£</span>
                    <span>Carica un file Excel con TUTTI gli interventi che vuoi nello storico (es. anno 2025, gennaio 2026, ecc.)</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">2Ô∏è‚É£</span>
                    <span>Genera il file <code class="bg-blue-100 px-2 py-0.5 rounded">sbolla.json</code> che verr√† salvato nella cartella Download</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">3Ô∏è‚É£</span>
                    <span><strong>Sposta manualmente</strong> il file nella stessa cartella di <code class="bg-blue-100 px-2 py-0.5 rounded">index.html</code></span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-0.5">4Ô∏è‚É£</span>
                    <span>All'avvio di <code class="bg-blue-100 px-2 py-0.5 rounded">index.html</code> il file verr√† caricato automaticamente come storico</span>
                </li>
                <li class="flex items-start gap-2 mt-3 text-xs text-blue-600">
                    <span>üì¢ Puoi aggiornarlo in qualsiasi momento ripetendo la procedura con file pi√π recenti</span>
                </li>
            </ul>
            
            <!-- Link a index.html anche qui -->
            <div class="mt-6 text-center">
                <a href="index.html" 
                   class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-md">
                    <span>üöÄ</span>
                    <span>Apri Sbolla Manager</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        let datiCaricati = null;
        let nomeFile = '';

        // Verifica se esiste gi√† sbolla.json (simulato)
        window.onload = function() {
            verificaJSON();
        };

        function verificaJSON() {
            // Non possiamo leggere file locali, mostriamo messaggio generico
            document.getElementById('json-info').innerHTML = `
                <div class="text-center">
                    <div class="text-5xl mb-4 text-amber-400">üì¢</div>
                    <div class="font-medium text-slate-600 text-lg">Genera un nuovo file</div>
                    <div class="text-sm text-slate-400 mt-2">Dopo aver generato sbolla.json, spostalo nella cartella di index.html</div>
                </div>
            `;
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            console.log("üìÇ File selezionato:", file.name);
            nomeFile = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});
                
                processData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(rows) {
            datiCaricati = rows;
            
            // Calcola statistiche
            let storici = 0;
            let nuovi = 0;
            
            rows.forEach(row => {
                const costo = parseFloat(row['COSTO']);
                if (!isNaN(costo) && costo > 0) {
                    storici++;
                } else {
                    nuovi++;
                }
            });
            
            const totale = rows.length;
            
            // Aggiorna UI
            document.getElementById('stats-totale').textContent = totale;
            document.getElementById('stats-storici').textContent = storici;
            document.getElementById('stats-nuovi').textContent = nuovi;
            
            document.getElementById('stats-section').classList.remove('hidden');
            
            console.log(`üìä Dati caricati: ${totale} totali (${storici} storici, ${nuovi} nuovi)`);
        }

        function generaJSON() {
            if (!datiCaricati) {
                alert('‚ùå Nessun dato da salvare!');
                return;
            }

            // Prepara i dati per il JSON
            const datiDaSalvare = {
                fileName: nomeFile,
                timestamp: new Date().toISOString(),
                interventi: datiCaricati,
                stats: {
                    totale: datiCaricati.length,
                    storici: document.getElementById('stats-storici').textContent,
                    nuovi: document.getElementById('stats-nuovi').textContent
                }
            };

            // Crea e scarica il file
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datiDaSalvare, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "sbolla.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            alert('‚úÖ sbolla.json generato con successo!\n\nüì¢ Ricorda: spostalo nella cartella di index.html');
            
            // Aggiorna info
            document.getElementById('json-info').innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-3 text-emerald-500">‚úÖ</div>
                    <div class="font-bold text-slate-700 text-lg">File generato: sbolla.json</div>
                    <div class="text-sm text-slate-500 mt-1">${datiCaricati.length} interventi salvati</div>
                    <div class="text-xs text-slate-400 mt-2">üìÖ ${new Date().toLocaleString()}</div>
                    <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200 text-amber-700 text-sm">
                        ‚ö†Ô∏è Ricorda di spostare il file nella cartella di index.html
                    </div>
                </div>
            `;
        }

        function reset() {
            datiCaricati = null;
            document.getElementById('stats-section').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }
    </script>
</body>
</html>